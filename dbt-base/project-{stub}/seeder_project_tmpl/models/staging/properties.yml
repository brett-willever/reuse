version: 2

shared: &shared
  database: '{{env_var("BIGQUERY_PROJECT_ID")}}'
  loader: iota
  # loaded_at_field: _dvp_metadata.loaded_at
  config:
    enabled: true
  meta:
    quality: low

## *********************
##  Source Configuration
## *********************
sources:
  - name: raw_us
    description: Raw Unmanaged Assets
    tags:
      - sbac
    <<: *shared
    tables:
      - name: eladownload2023
        columns:
          - name: cds
          - name: rtype
          - name: schoolname
          - name: districtname
          - name: countyname
          - name: charter_flag
          - name: coe_flag
          - name: dass_flag
          - name: studentgroup
          - name: currdenom
          - name: currstatus
          - name: priordenom
          - name: priorstatus
          - name: change
          - name: statuslevel
          - name: changelevel
          - name: color
          - name: box
          - name: currnsizemet
          - name: priornsizemet
          - name: accountabilitymet
          - name: hscutpoints
          - name: pairshare_method
          - name: currprate_enrolled
          - name: currprate_tested
          - name: currprate
          - name: currnumPRLOSS
          - name: currdenom_withoutPRLOSS
          - name: currstatus_withoutPRLOSS
          - name: priorprate_enrolled
          - name: priorprate_tested
          - name: priorprate
          - name: priornumPRLOSS
          - name: priordenom_withoutPRLOSS
          - name: priorstatus_withoutPRLOSS
          - name: indicator
          - name: reportingyear

      - name: sb_ca2023_all
        columns:
          - name: County_Code
          - name: District_Code
          - name: School_Code
          - name: Filler
          - name: Test_Year
          - name: Student_Group_ID
          - name: Test_Type
          - name: Total_Tested_at_Reporting_Level
          - name: Total_Tested_with_Scores_at_Reporting_Level
          - name: Grade
          - name: Test_ID
          - name: Students_Enrolled
          - name: Students_Tested
          - name: Mean_Scale_Score
          - name: Percentage_Standard_Exceeded
          - name: Percentage_Standard_Met
          - name: Percentage_Standard_Met_and_Above
          - name: Percentage_Standard_Nearly_Met
          - name: Percentage_Standard_Not_Met
          - name: Students_with_Scores
          - name: Area_1_Percentage_Above_Standard
          - name: Area_1_Percentage_Near_Standard
          - name: Area_1_Percentage_Below_Standard
          - name: Area_2_Percentage_Above_Standard
          - name: Area_2_Percentage_Near_Standard
          - name: Area_2_Percentage_Below_Standard
          - name: Area_3_Percentage_Above_Standard
          - name: Area_3_Percentage_Near_Standard
          - name: Area_3_Percentage_Below_Standard
          - name: Area_4_Percentage_Above_Standard
          - name: Area_4_Percentage_Near_Standard
          - name: Area_4_Percentage_Below_Standard
          - name: Type_ID

      - name: acgr23
        columns:
          - name: AcademicYear
          - name: AggregateLevel
          - name: CountyCode
          - name: DistrictCode
          - name: SchoolCode
          - name: CountyName
          - name: DistrictName
          - name: SchoolName
          - name: CharterSchool
          - name: DASS
          - name: ReportingCategory
          - name: CohortStudents
          - name: Regular_HS_Diploma_Graduates__Count_
          - name: Regular_HS_Diploma_Graduates__Rate_
          - name: Met_UC_CSU_Grad_Req_s__Count_
          - name: Met_UC_CSU_Grad_Req_s__Rate_
          - name: Seal_of_Biliteracy__Count_
          - name: Seal_of_Biliteracy__Rate_
          - name: Golden_State_Seal_Merit_Diploma__Count_
          - name: Golden_State_Seal_Merit_Diploma__Rate
          - name: CHSPE_Completer__Count_
          - name: CHSPE_Completer__Rate_
          - name: Adult_Ed__HS_Diploma__Count_
          - name: Adult_Ed__HS_Diploma__Rate_
          - name: SPED_Certificate__Count_
          - name: SPED_Certificate__Rate_
          - name: GED_Completer__Count_
          - name: GED_Completer__Rate_
          - name: Other_Transfer__Count_
          - name: Other_Transfer__Rate_
          - name: Dropout__Count_
          - name: Dropout__Rate_
          - name: Still_Enrolled__Count_
          - name: Still_Enrolled__Rate_
## *********************
##  Semantic Configuration
## *********************
# semantic_models:
#   - name: graduation_rate
#     description: |
#       A model containing graduation rate.
#     model: ref('stg')
#     defaults:
#       agg_time_dimension: metric_time
#     entities:
#       - name: academic_year
#         type: primary
#       - name: school_code
#         type: foreign
#       - name: district_code
#         type: foreign
#         expr: customer_id
#     measures:
#       - name: row_count
#         agg: sum
# dimensions:
#   - name: metric_time
#     expr: cast(ordered_at as date)
#     type: time
#     type_params:
#       time_granularity: day
#   - name: low_graduation_rate
#     type: categorical

## *********************
##  Models Configuration
## *********************
models:
  - name: academic_indicators_ela
    config:
      enabled: true
      database: '{{env_var("BIGQUERY_PROJECT_ID")}}'
      full_refresh: true
      materialized: incremental
      on_schema_change: fail
      labels:
        group: lacoe
        release: mvp
    columns:
      - name: cds
      - name: rtype
      - name: schoolname
      - name: districtname
      - name: countyname
      - name: charter_flag
      - name: coe_flag
      - name: dass_flag
      - name: studentgroup
      - name: currdenom
      - name: currstatus
      - name: priordenom
      - name: priorstatus
      - name: change
      - name: statuslevel
      - name: changelevel
      - name: color
      - name: box
      - name: currnsizemet
      - name: priornsizemet
      - name: accountabilitymet
      - name: hscutpoints
      - name: pairshare_method
      - name: currprate_enrolled
      - name: currprate_tested
      - name: currprate
      - name: currnumPRLOSS
      - name: currdenom_withoutPRLOSS
      - name: currstatus_withoutPRLOSS
      - name: priorprate_enrolled
      - name: priorprate_tested
      - name: priorprate
      - name: priornumPRLOSS
      - name: priordenom_withoutPRLOSS
      - name: priorstatus_withoutPRLOSS
      - name: indicator
      - name: reportingyear
             
  - name: assessments_sbac
    config:
      enabled: true
      database: '{{env_var("BIGQUERY_PROJECT_ID")}}'
      full_refresh: true
      materialized: incremental
      on_schema_change: fail
    columns:
      - name: county_code
      - name: district_code
      - name: school_code
      - name: filler
      - name: test_year
      - name: student_group_id
      - name: test_type
      - name: total_tested_at_reporting_level
      - name: total_tested_with_scores_at_reporting_level
      - name: grade
      - name: test_id
      - name: students_enrolled
      - name: students_tested
      - name: mean_scale_score
      - name: percentage_standard_exceeded
      - name: percentage_standard_met
      - name: Percentage_Standard_Met_And_Above
      - name: percentage_standard_nearly_met
      - name: percentage_standard_not_met
      - name: Students_with_Scores
      - name: area_1_percentage_above_standard
      - name: area_1_percentage_near_standard
      - name: area_1_percentage_below_standard
      - name: area_2_percentage_above_standard
      - name: area_2_percentage_near_standard
      - name: area_2_percentage_below_standard
      - name: area_3_percentage_above_standard
      - name: area_3_percentage_near_standard
      - name: area_3_percentage_below_standard
      - name: area_4_percentage_above_standard
      - name: area_4_percentage_near_standard
      - name: area_4_percentage_below_standard
      - name: type_id

  - name: academic_graduation_rate
    config:
      enabled: true
      database: '{{env_var("BIGQUERY_PROJECT_ID")}}'
      full_refresh: true
      materialized: incremental
      on_schema_change: fail
      # sort: event_time
      # dist: event_id
      contract:
        enforced: false
      cluster_by:
        - AggregateLevel
    columns:
      - name: AcademicYear
        data_type: INT64
        expr: CAST(academicYear AS FLOAT64)
        mode: REQUIRED
      - name: AggregateLevel
        data_type: INT64
      - name: CountyCode
        data_type: INT64

      - name: DistrictCode
        data_type: INT64

      - name: SchoolCode
        data_type: INT64

      - name: CountyName
        data_type: STRING

      - name: DistrictName
        data_type: STRING

      - name: SchoolName
        data_type: STRING

      - name: CharterSchool
        data_type: STRING

      - name: DASS
        data_type: STRING

      - name: ReportingCategory
        data_type: STRING
      - name: CohortStudents
        data_type: INT64

      - name: Regular_HS_Diploma_Graduates__Count_
        data_type: INT64

      - name: Regular_HS_Diploma_Graduates__Rate_
        data_type: FLOAT64

      - name: Met_UC_CSU_Grad_Req_s__Count_
        data_type: INT64

      - name: Met_UC_CSU_Grad_Req_s__Rate_
        data_type: FLOAT64

      - name: Seal_of_Biliteracy__Count_
        data_type: INT64

      - name: Seal_of_Biliteracy__Rate_
        data_type: FLOAT64

      - name: Golden_State_Seal_Merit_Diploma__Count_
        data_type: INT64

      - name: Golden_State_Seal_Merit_Diploma__Rate
        data_type: FLOAT64

      - name: CHSPE_Completer__Count_
        data_type: INT64

      - name: CHSPE_Completer__Rate_
        data_type: FLOAT64

      - name: Adult_Ed__HS_Diploma__Count_
        data_type: INT64

      - name: Adult_Ed__HS_Diploma__Rate_
        data_type: FLOAT64

      - name: SPED_Certificate__Count_
        data_type: INT64

      - name: SPED_Certificate__Rate_
        data_type: FLOAT64

      - name: GED_Completer__Count_
        data_type: INT64

      - name: GED_Completer__Rate_
        data_type: FLOAT64

      - name: Other_Transfer__Count_
        data_type: INT64

      - name: Other_Transfer__Rate_
        data_type: FLOAT64

      - name: Dropout__Count_
        data_type: INT64

      - name: Dropout__Rate_
        data_type: FLOAT64

      - name: Still_Enrolled__Count_
        data_type: INT64

      - name: Still_Enrolled__Rate_
        data_type: FLOAT64
